name: Amazon Jobs Location Monitor

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Query Amazon jobs GraphQL (location-based)
        run: |
          cat > payload.json <<'JSON'
          {
            "operationName": "searchJobCardsByLocation",
            "query": "query searchJobCardsByLocation($searchJobRequest: SearchJobRequest!) { searchJobCardsByLocation(searchJobRequest: $searchJobRequest) { nextToken jobCards { jobId jobTitle jobType employmentType city state postalCode locationName distance tagLine bannerText __typename } __typename } }",
            "variables": {
              "searchJobRequest": {
                "locale": "en-GB",
                "country": "United Kingdom",
                "pageSize": 100,
                "consolidateSchedule": true,
                "geoQueryClause": { "lat": 52.117190599496, "lng": -0.483199702801, "unit": "mi", "distance": 50 }
              }
            }
          }
          JSON

          curl -sS -X POST "https://qy64m4juabaffl7tjakii4gdoa.appsync-api.eu-west-1.amazonaws.com/graphql" \
            -H "content-type: application/json" \
            -H "user-agent: Mozilla/5.0" \
            --data-binary @payload.json \
            -o response.json

      - name: Build stable snapshot (jobId + title + location)
        run: |
          python - <<'PY'
          import json, hashlib, pathlib

          data = json.loads(pathlib.Path("response.json").read_text())
          cards = (((data.get("data") or {}).get("searchJobCardsByLocation") or {}).get("jobCards") or [])

          simplified = []
          for c in cards:
            jid = c.get("jobId")
            if not jid:
              continue
            simplified.append({
              "jobId": jid,
              "jobTitle": c.get("jobTitle"),
              "locationName": c.get("locationName"),
              "postalCode": c.get("postalCode"),
              "city": c.get("city"),
              "distance": c.get("distance"),
            })

          simplified.sort(key=lambda x: x["jobId"])

          text = json.dumps(simplified, ensure_ascii=False, separators=(",", ":"), sort_keys=True)
          pathlib.Path("snapshot.json").write_text(text)
          pathlib.Path("snapshot.sha").write_text(hashlib.sha256(text.encode("utf-8")).hexdigest())
          PY

      - name: Detect changes
        id: diff
        run: |
          echo "changed=true" >> $GITHUB_OUTPUT


      - name: Save latest snapshot
        run: |
          mv snapshot.json last_snapshot.json
          mv snapshot.sha last_snapshot.sha

      - name: Commit snapshot if changed
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "Job Monitor Bot"
          git config user.email "actions@users.noreply.github.com"
          git add last_snapshot.json last_snapshot.sha
          git commit -m "Jobs updated (location feed)" || exit 0
          git push

      - name: Create alert Issue (emails you via @mention)
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "@baddamarun" > issue_body.txt
          echo "" >> issue_body.txt
          echo "ðŸŸ¢ Jobs changed for your location feed." >> issue_body.txt
          echo "" >> issue_body.txt
          echo "Open the repo to view the latest snapshot:" >> issue_body.txt
          echo "- last_snapshot.json" >> issue_body.txt

          gh issue create \
            --title "ðŸŸ¢ Amazon jobs updated (location feed)" \
            --body-file issue_body.txt

